<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lagrede befaringer</title>
  <link rel="stylesheet" href="./styles.css">
  <style>
    .page { max-width: 1100px; margin: 16px auto; padding: 0 12px; }
    .filter-box { background:#fff; padding:16px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.08); margin-bottom:16px; }
    .list { display:flex; flex-direction:column; gap:12px; }
    .card-row { background:#fff; border-radius:8px; padding:16px; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
    .card-row h3 { margin:0 0 4px 0; }
    .muted { color:#666; }
    .tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .tag { background:#eef2f7; color:#2f3b52; padding:4px 10px; border-radius:999px; font-size:12px; }
    .tag.klp { background:#fff3e0; color:#c25b00; font-weight:600; }
    .actions { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .btn.small { padding:6px 10px; font-size:13px; }
    .stats { display:flex; gap:12px; flex-wrap:wrap; margin:12px 0; }
    .stat { background:#fff; padding:12px 14px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.08); min-width:160px; }
    .stat .num { font-size:22px; font-weight:700; }
  </style>
</head>
<body>
  <header class="header">
    <div class="wrap header__bar">
      <div class="brand">
        <div class="logo">B</div>
        <div>
          <div class="t1">Lagrede befaringer</div>
          <div class="t2">Søk • Filtrer • Rediger</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="window.location.href='index.html'">← Ny befaring</button>
      </div>
    </div>
  </header>

  <main class="page">
    <div class="stats" id="stats"></div>

    <div class="filter-box">
      <div class="row">
        <div>
          <label>Søk</label>
          <input id="search" placeholder="Kundenavn, adresse, orgnr" />
        </div>
        <div>
          <label>KLP-deltaker</label>
          <select id="klpFilter">
            <option value="">Alle</option>
          </select>
        </div>
        <div>
          <label>Sortering</label>
          <select id="sortOrder">
            <option value="customer">Kunde (A-Å)</option>
            <option value="customer-desc">Kunde (Å-A)</option>
            <option value="date-new">Dato (nyest først)</option>
            <option value="date-old">Dato (eldst først)</option>
          </select>
        </div>
      </div>
    </div>

    <div class="list" id="list"></div>
  </main>

<script>
function esc(s){ return String(s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c])); }

function loadInspections(){
  return JSON.parse(localStorage.getItem('savedInspections')||'[]');
}
function saveInspections(list){
  localStorage.setItem('savedInspections', JSON.stringify(list));
}

function klpNames(list){
  const set = new Set();
  list.forEach(insp => {
    (insp.attendees||[]).forEach(a => {
      if((a.employer||'').toLowerCase().includes('klp')) set.add(a.name||'');
    });
    if(insp.reportAuthor) set.add(insp.reportAuthor);
  });
  return Array.from(set).filter(Boolean).sort((a,b)=>a.localeCompare(b,'nb'));
}

function renderStats(list){
  const total = list.length;
  const totalItems = list.reduce((s,x)=> s + (x.items?.length||0), 0);
  const klps = klpNames(list).length;
  document.getElementById('stats').innerHTML = `
    <div class="stat"><div class="num">${total}</div><div>befaringer</div></div>
    <div class="stat"><div class="num">${klps}</div><div>KLP-deltakere</div></div>
    <div class="stat"><div class="num">${totalItems}</div><div>registrerte punkt</div></div>
  `;
}

function applyFilters(list){
  const search = document.getElementById('search').value.toLowerCase();
  const klp = document.getElementById('klpFilter').value;
  const sort = document.getElementById('sortOrder').value;

  let res = list.filter(insp => {
    const addr = insp.locations?.[0]?.address || '';
    return (!search ||
      (insp.customer?.name||'').toLowerCase().includes(search) ||
      (insp.customer?.orgnr||'').includes(search) ||
      addr.toLowerCase().includes(search));
  });

  if(klp){
    res = res.filter(insp => (insp.attendees||[]).some(a => a.name === klp && (a.employer||'').toLowerCase().includes('klp')) || insp.reportAuthor === klp);
  }

  res.sort((a,b)=>{
    switch(sort){
      case 'customer': return (a.customer?.name||'').localeCompare(b.customer?.name||'', 'nb');
      case 'customer-desc': return (b.customer?.name||'').localeCompare(a.customer?.name||'', 'nb');
      case 'date-new': return new Date(b.inspectionDate||0) - new Date(a.inspectionDate||0);
      case 'date-old': return new Date(a.inspectionDate||0) - new Date(b.inspectionDate||0);
      default: return 0;
    }
  });
  return res;
}

function renderList(list){
  const root = document.getElementById('list');
  if(!list.length){ root.innerHTML = '<div class="card-row"><p class="muted">Ingen lagrede befaringer.</p></div>'; return; }

  root.innerHTML = list.map(insp => {
    const loc = insp.locations?.[0] || {};
    const klpTags = (insp.attendees||[]).filter(a => (a.employer||'').toLowerCase().includes('klp'));
    return `
      <div class="card-row">
        <h3>${esc(insp.customer?.name||'Ukjent kunde')}</h3>
        <div class="muted">Dato: ${esc(insp.inspectionDate||'—')} • Org.nr: ${esc(insp.customer?.orgnr||'—')}</div>
        <div class="muted">Adresse: ${esc(loc.address||'—')}</div>
        <div class="tags">
          <span class="tag">Punkter: ${insp.items?.length||0}</span>
          ${insp.reportAuthor ? `<span class="tag klp">${esc(insp.reportAuthor)}</span>` : ''}
          ${klpTags.map(a=>`<span class="tag klp">${esc(a.name)}</span>`).join('')}
        </div>
        <div class="actions">
          <button class="btn small" onclick="viewInspection(${insp.id})">Vis</button>
          <button class="btn small" onclick="editInspection(${insp.id})">Rediger</button>
          <button class="btn danger small" onclick="deleteInspection(${insp.id})">Slett</button>
        </div>
      </div>
    `;
  }).join('');
}

function viewInspection(id){
  const insp = loadInspections().find(x=>x.id===id);
  if(!insp) return;
  sessionStorage.setItem('reportPayload', JSON.stringify(insp));
  window.location.href = 'report.html';
}
function editInspection(id){
  const insp = loadInspections().find(x=>x.id===id);
  if(!insp) return;
  sessionStorage.setItem('editingInspection', JSON.stringify(insp));
  window.location.href = 'index.html';
}
function deleteInspection(id){
  if(!confirm('Slette denne befaringen?')) return;
  const list = loadInspections().filter(x=>x.id!==id);
  saveInspections(list);
  init();
}

function init(){
  const list = loadInspections();
  renderStats(list);
  const klps = klpNames(list);
  document.getElementById('klpFilter').innerHTML = '<option value="">Alle</option>' + klps.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');

  const rerender = ()=> renderList(applyFilters(loadInspections()));
  ['search','klpFilter','sortOrder'].forEach(id=>{
    document.getElementById(id).addEventListener('input', rerender);
    document.getElementById(id).addEventListener('change', rerender);
  });

  renderList(applyFilters(list));
}

init();
</script>
</body>
</html>
