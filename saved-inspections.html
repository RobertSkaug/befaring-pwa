<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lagrede befaringer</title>
  <link rel="stylesheet" href="./styles.css">
  <link rel="stylesheet" href="./print.css">
  <style>
    .page { max-width: 1100px; margin: 16px auto; padding: 0 12px; }
    .filter-box { background:#fff; padding:16px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.08); margin-bottom:16px; }
    .list { display:flex; flex-direction:column; gap:12px; }
    .card-row { background:#fff; border-radius:8px; padding:16px; box-shadow:0 1px 4px rgba(0,0,0,0.08); }
    .card-row h3 { margin:0 0 4px 0; }
    .muted { color:#666; }
    .tags { display:flex; flex-wrap:wrap; gap:6px; margin-top:8px; }
    .tag { background:#eef2f7; color:#2f3b52; padding:4px 10px; border-radius:999px; font-size:12px; }
    .tag.klp { background:#fff3e0; color:#c25b00; font-weight:600; }
    .actions { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .btn.small { padding:6px 10px; font-size:13px; }
    .stats { display:flex; gap:12px; flex-wrap:wrap; margin:12px 0; }
    .stat { background:#fff; padding:12px 14px; border-radius:8px; box-shadow:0 1px 4px rgba(0,0,0,0.08); min-width:160px; }
    .stat .num { font-size:22px; font-weight:700; }
  </style>
</head>
<body>
  <header class="header">
    <div class="wrap header__bar">
      <div class="brand">
        <div class="logo">B</div>
        <div>
          <div class="t1">Lagrede befaringer</div>
          <div class="t2">S√∏k ‚Ä¢ Filtrer ‚Ä¢ Rediger</div>
        </div>
      </div>
      <div class="actions">
        <button class="btn" onclick="window.location.href='index.html'">‚Üê Ny befaring</button>
      </div>
    </div>
  </header>

  <main class="page">
    <div class="stats" id="stats"></div>

    <div class="filter-box">
      <div class="row">
        <div>
          <label>S√∏k</label>
          <input id="search" placeholder="Kundenavn, adresse, orgnr" />
        </div>
        <div>
          <label>Fra dato</label>
          <input id="dateFrom" type="date" />
        </div>
        <div>
          <label>Til dato</label>
          <input id="dateTo" type="date" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>KLP-deltaker</label>
          <select id="klpFilter">
            <option value="">Alle</option>
          </select>
        </div>
        <div>
          <label>Sortering</label>
          <select id="sortOrder">
            <option value="customer" selected>Kunde (A-√Ö)</option>
            <option value="customer-desc">Kunde (√Ö-A)</option>
            <option value="date-new">Dato (nyest f√∏rst)</option>
            <option value="date-old">Dato (eldst f√∏rst)</option>
          </select>
        </div>
      </div>
    </div>

    <!-- P√•begynte befaringer -->
    <div>
      <h2 style="margin-top:20px; margin-bottom:12px;">üìù P√•begynte befaringer</h2>
      <div class="list" id="listInProgress"></div>
    </div>

    <!-- Avsluttede befaringer -->
    <div>
      <h2 style="margin-top:20px; margin-bottom:12px;">‚úÖ Avsluttede befaringer</h2>
      <div class="list" id="listCompleted"></div>
    </div>
  </main>

<script>
function esc(s){ return String(s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"}[c])); }

function loadInspections(){
  return JSON.parse(localStorage.getItem('savedInspections')||'[]');
}
function saveInspections(list){
  localStorage.setItem('savedInspections', JSON.stringify(list));
}

function klpNames(list){
  const set = new Set();
  list.forEach(insp => {
    (insp.attendees||[]).forEach(a => {
      if((a.employer||'').toLowerCase().includes('klp')) set.add(a.name||'');
    });
    if(insp.reportAuthor) set.add(insp.reportAuthor);
  });
  return Array.from(set).filter(Boolean).sort((a,b)=>a.localeCompare(b,'nb'));
}

function renderStats(list){
  const total = list.length;
  const inProgress = list.filter(x => x.status !== 'avsluttet').length;
  const completed = list.filter(x => x.status === 'avsluttet').length;
  const totalItems = list.reduce((s,x)=> s + (x.items?.length||0), 0);
  const klps = klpNames(list).length;
  document.getElementById('stats').innerHTML = `
    <div class="stat"><div class="num">${total}</div><div>befaringer</div></div>
    <div class="stat"><div class="num">${inProgress}</div><div>p√•begynte</div></div>
    <div class="stat"><div class="num">${completed}</div><div>avsluttede</div></div>
    <div class="stat"><div class="num">${klps}</div><div>KLP-deltakere</div></div>
    <div class="stat"><div class="num">${totalItems}</div><div>registrerte punkt</div></div>
  `;
}

function applyFilters(list){
  const search = document.getElementById('search').value.toLowerCase();
  const klp = document.getElementById('klpFilter').value;
  const sort = document.getElementById('sortOrder').value;
  const dateFrom = document.getElementById('dateFrom').value;
  const dateTo = document.getElementById('dateTo').value;

  let res = list.filter(insp => {
    const addr = insp.locations?.[0]?.address || '';
    const matchesSearch = !search ||
      (insp.customer?.name||'').toLowerCase().includes(search) ||
      (insp.customer?.orgnr||'').includes(search) ||
      addr.toLowerCase().includes(search);

    // Datofiltring
    const inspDate = insp.inspectionDate ? new Date(insp.inspectionDate) : null;
    const fromDate = dateFrom ? new Date(dateFrom) : null;
    const toDate = dateTo ? new Date(dateTo) : null;

    let matchesDate = true;
    if(inspDate){
      if(fromDate && inspDate < fromDate) matchesDate = false;
      if(toDate && inspDate > toDate) matchesDate = false;
    }

    return matchesSearch && matchesDate;
  });

  if(klp){
    res = res.filter(insp => (insp.attendees||[]).some(a => a.name === klp && (a.employer||'').toLowerCase().includes('klp')) || insp.reportAuthor === klp);
  }

  res.sort((a,b)=>{
    switch(sort){
      case 'customer': return (a.customer?.name||'').localeCompare(b.customer?.name||'', 'nb');
      case 'customer-desc': return (b.customer?.name||'').localeCompare(a.customer?.name||'', 'nb');
      case 'date-new': return new Date(b.inspectionDate||0) - new Date(a.inspectionDate||0);
      case 'date-old': return new Date(a.inspectionDate||0) - new Date(b.inspectionDate||0);
      default: return 0;
    }
  });
  return res;
}

function renderCard(insp){
  const loc = insp.locations?.[0] || {};
  const klpTags = (insp.attendees||[]).filter(a => (a.employer||'').toLowerCase().includes('klp'));
  const status = insp.status === 'avsluttet' ? '‚úÖ Avsluttet' : 'üìù P√•begynt';
  return `
    <div class="card-row">
      <h3>${esc(insp.customer?.name||'Ukjent kunde')}</h3>
      <div class="muted">Dato: ${esc(insp.inspectionDate||'‚Äî')} ‚Ä¢ Org.nr: ${esc(insp.customer?.orgnr||'‚Äî')} ‚Ä¢ ${status}</div>
      <div class="muted">Adresse: ${esc(loc.address||'‚Äî')}</div>
      <div class="tags">
        <span class="tag">Punkter: ${insp.items?.length||0}</span>
        ${insp.reportAuthor ? `<span class="tag klp">${esc(insp.reportAuthor)}</span>` : ''}
        ${klpTags.map(a=>`<span class="tag klp">${esc(a.name)}</span>`).join('')}
      </div>
      <div class="actions">
        <button class="btn small" onclick="viewInspection(${insp.id})">Vis rapport</button>
        <button class="btn small" onclick="editInspection(${insp.id})">Rediger</button>
        <button class="btn danger small" onclick="deleteInspection(${insp.id})">Slett</button>
      </div>
    </div>
  `;
}

function renderLists(list){
  const inProgressList = list.filter(x => x.status !== 'avsluttet');
  const completedList = list.filter(x => x.status === 'avsluttet');

  const renderContainer = (items) => {
    if(!items.length) return '<div class="card-row"><p class="muted">Ingen befaringer i denne kategorien.</p></div>';
    return items.map(renderCard).join('');
  };

  document.getElementById('listInProgress').innerHTML = renderContainer(inProgressList);
  document.getElementById('listCompleted').innerHTML = renderContainer(completedList);
}

function viewInspection(id){
  const insp = loadInspections().find(x=>x.id===id);
  if(!insp) return;
  sessionStorage.setItem('reportPayload', JSON.stringify(insp));
  window.location.href = 'report.html';
}
function editInspection(id){
  const insp = loadInspections().find(x=>x.id===id);
  if(!insp) return;
  sessionStorage.setItem('editingInspection', JSON.stringify(insp));
  window.location.href = 'index.html';
}
function deleteInspection(id){
  if(!confirm('Slette denne befaringen?')) return;
  const list = loadInspections().filter(x=>x.id!==id);
  saveInspections(list);
  init();
}

function init(){
  const list = loadInspections();
  renderStats(list);
  const klps = klpNames(list);
  document.getElementById('klpFilter').innerHTML = '<option value="">Alle</option>' + klps.map(n=>`<option value="${esc(n)}">${esc(n)}</option>`).join('');

  const rerender = ()=> renderLists(applyFilters(loadInspections()));
  ['search','klpFilter','sortOrder','dateFrom','dateTo'].forEach(id=>{
    document.getElementById(id).addEventListener('input', rerender);
    document.getElementById(id).addEventListener('change', rerender);
  });

  renderLists(applyFilters(list));
}

init();
</script>
</body>
</html>
