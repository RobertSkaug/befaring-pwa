<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Befaringsapp</title>

  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#3D3D3D">
  
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png">
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">

  <link rel="stylesheet" href="./styles.css">
  
  <!-- Fabric.js for canvas annotations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
</head>
<body>
<header class="header">
  <div class="wrap header__bar">
    <div class="brand">
      <div class="logo">B</div>
      <div>
        <div class="t1">Befaringsrapport</div>
        <div class="t2" id="todayLabel">Risikogjennomgang</div>
      </div>
    </div>
    <div class="actions">
      <button class="btn" id="btnUpdateApp" style="display:none;">Oppdater app</button>
      <button class="btn" id="btnBackToLanding" style="display:none;">Til start</button>
      <button class="btn" id="btnGoLocations" style="display:none;">Lokasjoner</button>
      <button class="btn" id="btnGoFindings" style="display:none;">Avvik/Anbefaling</button>
      <button class="btn" id="btnGoReport" style="display:none;">üìÑ Rapport</button>
    </div>
  </div>
</header>

<main class="wrap">

  <!-- TRINN 0: LANDING -->
  <section class="card" id="stepLanding">
    <h1 style="margin:0 0 6px;">Befaringsrapport ‚Äì Risikogjennomgang</h1>
    <div class="muted" id="landingDate"></div>

    <hr style="margin:14px 0; border:none; border-top:1px solid #eee;">

    <h2>Kunde / eier av bygg (BRREG)</h2>
    <p class="muted">S√∏k med org.nr (9 siffer) eller navn. Velg riktig treff.</p>

    <div class="row">
      <div>
        <label>Org.nr</label>
        <input id="orgnr" inputmode="numeric" placeholder="9 siffer" />
      </div>
      <div>
        <label>S√∏k p√• navn</label>
        <input id="companySearch" placeholder="F.eks. 'Oslo kommune' / 'ABC AS'" />
      </div>
    </div>

    <div class="inline">
      <button class="btn" id="btnSearchBrreg">S√∏k</button>
      <span class="status" id="brregStatus">BRREG: klar</span>
    </div>

    <div id="brregResults" class="addrBox" style="display:none;">
      <div class="addrBox__title">Treff fra BRREG (velg)</div>
      <div id="brregList" class="addrBox__list"></div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label>Kundenavn</label>
        <input id="customerName" placeholder="Fylles fra BRREG" />
      </div>
      <div>
        <label>Organisasjonsform</label>
        <input id="orgForm" placeholder="Fylles fra BRREG" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>N√¶ringskode</label>
        <input id="industry" placeholder="Fylles hvis tilgjengelig" />
      </div>
      <div></div>
    </div>

    <hr style="margin:14px 0; border:none; border-top:1px solid #eee;">

    <h2>Deltakere</h2>

    <div class="split">
      <div class="subcard">
        <div class="subhead">
          <h3 style="margin:0;">KLP</h3>
          <button class="btn" id="btnAddKlp">+ Legg til</button>
        </div>
        <div id="klpAttendees"></div>
      </div>

      <div class="subcard">
        <div class="subhead">
          <h3 style="margin:0;" id="customerHeading">Kunde</h3>
          <button class="btn" id="btnAddCustomerAtt">+ Legg til</button>
        </div>
        <div id="customerAttendees"></div>
      </div>
    </div>

    <div class="footerActions">
      <button class="btn primary" id="btnStartInspection">Start befaring</button>
    </div>
  </section>

  <!-- TRINN 1: LOKASJONER + GPS + BYGGINFO -->
  <section class="card" id="stepLocations" style="display:none;">
    <div class="locHeader">
      <h2 style="margin:0;">Lokasjoner (flere objekter)</h2>
      <button class="btn primary" id="btnAddLocation">+ Ny lokasjon</button>
    </div>

    <div id="locTabs" class="locTabs"></div>

    <div class="row">
      <div>
        <label>Adresse (velg fra forslag)</label>
        <input id="address" placeholder="Adresse" />
      </div>
      <div>
        <label>Objektnavn (valgfritt)</label>
        <input id="objectName" placeholder="F.eks. Bygg A / Lager / Skolebygg" />
      </div>
    </div>

    <div class="inline">
      <button class="btn" id="btnGPS">Hent GPS + foresl√• adresser</button>
      <span class="pill"><span class="dot green"></span><span id="gpsStatus">GPS: ikke hentet</span></span>
    </div>

    <div id="addrBox" class="addrBox" style="display:none;">
      <div class="addrBox__title">Forslag til adresse n√¶r deg</div>
      <div id="addrSuggestions" class="addrBox__list"></div>
      <div class="muted">Velg riktig adresse. Du kan fortsatt redigere manuelt.</div>
    </div>

    <hr style="margin:16px 0; border:none; border-top:1px solid #eee;">

    <div class="locHeader">
      <h3 style="margin:0;">Bygg p√• denne lokasjonen</h3>
      <button class="btn primary" id="btnAddBuilding">+ Nytt bygg</button>
    </div>

    <div id="buildingTabs" class="locTabs"></div>

    <div class="row">
      <div>
        <label>Byggbeskrivelse (heading)</label>
        <input id="buildingLabel" placeholder="F.eks. Hovedbygg / Lagerbygg / Verksted" />
      </div>
      <div>
        <label>Bygningsnummer
          <a href="https://eiendomsinnsyn.no/" target="_blank" style="margin-left: 8px; font-size: 11px; color: var(--p); text-decoration: none; font-weight: 900;">Hent fra eiendomsinnsyn.no ‚Üó</a>
        </label>
        <input id="buildingNo" placeholder="Bygningsnummer" />
      </div>
    </div>

    <hr style="margin:16px 0; border:none; border-top:1px solid #eee;">

    <h3>1. Beskrivelse av bygg (for valgt lokasjon)</h3>

    <div>
      <label>Virksomhet i bygg (flere mulig)</label>
      <input id="businessManual" placeholder="Legg til manuelt og trykk Enter‚Ä¶" />
      <div class="chips" id="businessSelected"></div>
      <div class="muted" id="businessStatus" style="margin-top:6px;"></div>
    </div>

    <div class="inline">
      <button class="btn" id="btnSuggestBusiness">Foresl√• virksomhet (offentlige kilder)</button>
      <span class="muted" id="businessStatus"></span>
    </div>

    <div id="businessSuggestions" class="addrBox" style="display:none;">
      <div class="addrBox__title">Forslag (velg ett)</div>
      <div id="businessList" class="addrBox__list"></div>
    </div>

    <div class="row">
      <div>
        <label>Bygge√•r</label>
        <input id="buildYear" inputmode="numeric" placeholder="√Ör" />
      </div>
      <div>
        <label>Totalareal (m¬≤)</label>
        <input id="areaM2" inputmode="numeric" placeholder="m¬≤" />
      </div>
    </div>

    <div class="muted" style="margin-top:8px;">
      Fordel totalarealet per bruksomr√•de (basert p√• valgte virksomheter).
    </div>
    <div id="areaBreakdown"></div>
    <div class="muted" id="areaSumStatus"></div>

    <div class="row">
      <div>
        <label>Antall etg.</label>
        <input id="floors" inputmode="numeric" placeholder="Antall" />
      </div>
      <div></div>
    </div>

    <label>Bygningsmaterialer</label>
    <div class="chips" id="matChips"></div>

    <label>Beskyttelse</label>
    <div class="chips" id="protChips"></div>

    <h4 style="margin-top:14px;">Konstruksjon</h4>

    <label>S√∏yler</label>
    <div class="chips" id="colChips"></div>

    <label>Bjelker</label>
    <div class="chips" id="beamChips"></div>

    <label>Dekke</label>
    <div class="chips" id="deckChips"></div>

    <label>Tak</label>
    <div class="chips" id="roofChips"></div>

    <label>Yttervegg</label>
    <div class="chips" id="wallChips"></div>

    <label>Bygningsbeskrivelse</label>
    <textarea id="bDesc"></textarea>

    <label>Sikkerhetsforhold</label>
    <textarea id="bSafety"></textarea>

    <label>Generell vurdering av risiko</label>
    <textarea id="bRisk"></textarea>

    <div class="footerActions">
      <button class="btn" id="btnToFindings">Registrer avvik/anbefaling</button>
    </div>
  </section>

  <!-- TRINN 2: AVVIK / ANBEFALING (knyttes til objekt) -->
  <section class="card" id="stepFindings" style="display:none;">
    <h2>Avvik / anbefaling</h2>
    <p class="muted">Legg inn avvik/anbefaling og koble til riktig objekt dersom det finnes flere lokasjoner.</p>

    <div class="row">
      <div>
        <label>Gjelder objekt</label>
        <select id="findingLocation"></select>
      </div>
      <div>
        <label>Type</label>
        <select id="findingType">
          <option value="AVVIK" selected>Avvik</option>
          <option value="ANBEFALING">Anbefaling</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Alvorlighet (kun avvik)</label>
        <select id="findingSeverity">
          <option value="H√∏y">H√∏y</option>
          <option value="Middels" selected>Middels</option>
          <option value="Lav">Lav</option>
        </select>
      </div>
      <div>
        <label>Frist (kun avvik)</label>
        <input id="findingDue" type="date" />
      </div>
    </div>

    <label>Tittel</label>
    <input id="findingTitle" placeholder="Kort beskrivelse" />

    <label>Beskrivelse</label>
    <textarea id="findingDesc" placeholder="Hva er observert? Hva anbefales?"></textarea>

    <div class="inline" style="margin-top: 12px;">
      <button class="btn primary" id="btnAddImageAnnotations">üì∑ Legg til bilder</button>
    </div>

    <div id="imageThumbnails"></div>

    <div class="inline">
      <button class="btn" id="btnAiSuggest" style="display:none;">ü§ñ Foresl√• tekst fra bilde (AI)</button>
    </div>

    <div id="aiSuggestStatus" style="display:none; margin-top:8px; padding:8px; background:#f0f0f0; border-radius:4px;">
      <div class="muted" id="aiSuggestMessage"></div>
    </div>

    <div class="inline">
      <button class="btn primary" id="btnAddFinding">Legg til</button>
    </div>

    <div id="findingList"></div>

    <hr style="margin:24px 0; border:none; border-top:1px solid #eee;">

    <div class="footerActions">
      <button class="btn" id="btnBackToLocations">Tilbake: Lokasjoner</button>
    </div>
  </section>

  <!-- TRINN 3: RAPPORT -->
  <section class="card" id="stepReport" style="display:none;">
    <div class="report-header">
      <h1>Rapport</h1>
      <div class="inline">
        <button class="btn" id="btnExportPDF">üìÑ √Öpne som PDF</button>
        <button class="btn primary" id="btnExportEmail">üìß Send p√• e-post</button>
        <button class="btn" id="btnExportWord">üìù Last ned Word</button>
      </div>
    </div>

    <hr style="margin:20px 0; border:none; border-top:1px solid #ddd;">

    <div id="reportPreview" class="report-preview">
      <!-- Rapporten rendres her av JavaScript -->
    </div>
  </section>

</main>

<script src="./imageStore.js"></script>
<script src="./imageAnnotator.js"></script>
<script src="./imageCaptureFlow.js"></script>
<script src="./thumbnailGrid.js"></script>
<script src="./app.js"></script>
</body>
</html>
