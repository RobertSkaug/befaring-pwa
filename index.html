<!doctype html>
<html lang="nb">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Befaringsapp</title>

  <link rel="manifest" href="./manifest.webmanifest">
  <meta name="theme-color" content="#3D3D3D">
  
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192.png">
  <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512.png">
  <link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">

  <link rel="stylesheet" href="./styles.css">
  <link rel="stylesheet" href="./buttons.css">
  <link rel="stylesheet" href="./report.css">
  
  <!-- Fabric.js for canvas annotations -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
</head>
<body id="top">
<header class="header">
  <div class="wrap header__bar">
    <div class="brand">
      <img class="logo-img" src="./apple-touch-icon.png" alt="Befaring">
      <div>
        <div class="t1">Befaringsrapport</div>
        <div class="t2" id="todayLabel">Risikogjennomgang</div>
      </div>
    </div>
    <div class="actions">
      <button class="btn btn--tertiary" id="btnUpdateApp" style="display:none;">Oppdater app</button>
      <button class="btn btn--tertiary" id="btnBackToLanding" style="display:none;">Til start</button>
      <button class="btn btn--tertiary" id="btnGoLocations" style="display:none;">Lokasjoner</button>
      <button class="btn btn--tertiary" id="btnGoFindings" style="display:none;">Avvik/Anbefaling</button>
      <button class="btn btn--tertiary" id="btnGoReport" style="display:none;">ðŸ“„ Rapport</button>
    </div>
  </div>
</header>

<!-- Mobil meny (in-flow, ikke sticky) -->
<section class="wrap mobile-menu">
  <details>
    <summary>â˜° Meny</summary>
    <div class="mobile-menu__panel">
      <div class="btn-row">
        <button class="btn btn--tertiary" id="mBtnUpdateApp" style="display:none;">Oppdater app</button>
        <button class="btn btn--tertiary" id="mBtnBackToLanding" style="display:none;">Til start</button>
        <button class="btn btn--tertiary" id="mBtnGoLocations" style="display:none;">Lokasjoner</button>
        <button class="btn btn--tertiary" id="mBtnGoFindings" style="display:none;">Avvik/Anbefaling</button>
        <button class="btn btn--tertiary" id="mBtnGoReport" style="display:none;">ðŸ“„ Rapport</button>
      </div>
    </div>
  </details>
</section>

<main class="wrap">

  <!-- TRINN 0: LANDING -->
  <section class="card" id="stepLanding">
    <h1 style="margin:0 0 6px;">Befaringsrapport â€“ Risikogjennomgang</h1>
    <div class="muted" id="landingDate"></div>

    <hr style="margin:14px 0; border:none; border-top:1px solid #eee;">

    <h2>Kunde / eier av bygg (BRREG)</h2>
    <p class="muted">SÃ¸k med org.nr (9 siffer) eller navn. Velg riktig treff.</p>

    <div class="row">
      <div>
        <label>Org.nr</label>
        <input id="orgnr" inputmode="numeric" placeholder="9 siffer" />
      </div>
      <div>
        <label>SÃ¸k pÃ¥ navn</label>
        <input id="companySearch" placeholder="F.eks. 'Oslo kommune' / 'ABC AS'" />
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn--secondary" id="btnSearchBrreg">SÃ¸k</button>
      <span class="status" id="brregStatus">BRREG: klar</span>
    </div>

    <div id="brregResults" class="addrBox" style="display:none;">
      <div class="addrBox__title">Treff fra BRREG (velg)</div>
      <div id="brregList" class="addrBox__list"></div>
    </div>

    <div class="row" style="margin-top:12px;">
      <div>
        <label>Kundenavn</label>
        <input id="customerName" placeholder="Fylles fra BRREG" />
      </div>
      <div>
        <label>Organisasjonsform</label>
        <input id="orgForm" placeholder="Fylles fra BRREG" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>NÃ¦ringskode</label>
        <input id="industry" placeholder="Fylles hvis tilgjengelig" />
      </div>
      <div></div>
    </div>

    <hr style="margin:14px 0; border:none; border-top:1px solid #eee;">

    <h2>Deltakere</h2>

    <div class="split">
      <div class="subcard">
        <div class="subhead">
          <h3 style="margin:0;">KLP</h3>
        </div>
        <div id="klpAttendees"></div>
      </div>
      <div class="btn-row">
        <button class="btn btn--chip" id="btnAddKlp">+ Legg til flere</button>
      </div>

      <div class="subcard">
        <div class="subhead">
          <h3 style="margin:0;" id="customerHeading">Kunde</h3>
        </div>
        <div id="customerAttendees"></div>
      </div>
    </div>

    <div class="mobile-actionbar">
      <div class="btn-row">
        <button class="btn btn--chip" id="btnAddCustomerAtt">+ Legg til flere</button>
        <button class="btn btn--primary" id="btnStartInspection">Start befaring</button>
      </div>
    </div>
  </section>

  <!-- TRINN 1: LOKASJONER + GPS + BYGGINFO -->
  <section class="card" id="stepLocations" style="display:none;">
    <div class="locHeader">
      <h2 style="margin:0;">Lokasjoner (flere objekter)</h2>
    </div>

    <div id="locTabs" class="locTabs"></div>

    <div class="row">
      <div>
        <label>Adresse (velg fra forslag)</label>
        <input id="address" placeholder="Adresse" />
      </div>
      <div>
        <label>Objektnavn (valgfritt)</label>
        <input id="objectName" placeholder="F.eks. Bygg A / Lager / Skolebygg" />
      </div>
    </div>

    <div class="btn-row">
      <button class="btn btn--secondary" id="btnGPS">Hent GPS + foreslÃ¥ adresser</button>
      <span class="pill"><span class="dot green"></span><span id="gpsStatus">GPS: ikke hentet</span></span>
    </div>

    <div id="addrBox" class="addrBox" style="display:none;">
      <div class="addrBox__title">Forslag til adresse nÃ¦r deg</div>
      <div id="addrSuggestions" class="addrBox__list"></div>
      <div class="muted">Velg riktig adresse. Du kan fortsatt redigere manuelt.</div>
    </div>

    <hr style="margin:16px 0; border:none; border-top:1px solid #eee;">

    <div class="btn-row">
      <button class="btn btn--chip" id="btnAddLocation">+ Ny lokasjon</button>
    </div>

    <div class="locHeader">
      <h3 style="margin:0;">Bygg pÃ¥ denne lokasjonen</h3>
    </div>

    <div id="buildingTabs" class="locTabs"></div>

    <div class="row">
      <div>
        <label>Byggbeskrivelse (heading)</label>
        <input id="buildingLabel" placeholder="F.eks. Hovedbygg / Lagerbygg / Verksted" />
      </div>
      <div>
        <label>Bygningsnummer
          <a href="https://eiendomsinnsyn.no/" target="_blank" style="margin-left: 8px; font-size: 11px; color: var(--p); text-decoration: none; font-weight: 900;">Hent fra eiendomsinnsyn.no â†—</a>
        </label>
        <input id="buildingNo" placeholder="Bygningsnummer" />
      </div>
    </div>

    <hr style="margin:16px 0; border:none; border-top:1px solid #eee;">

    <h3>1. Beskrivelse av bygg (for valgt lokasjon)</h3>

    <div>
      <label>Virksomhet i bygg (flere mulig)</label>
      <input id="businessManual" placeholder="Legg til manuelt og trykk Enterâ€¦" />
      <div class="chips" id="businessSelected"></div>
      <div class="muted" id="businessStatus" style="margin-top:6px;"></div>
    </div>

    <div class="btn-row">
      <button class="btn btn--secondary" id="btnSuggestBusiness">ForeslÃ¥ virksomhet (offentlige kilder)</button>
      <span class="muted" id="businessStatus"></span>
    </div>

    <div id="businessSuggestions" class="addrBox" style="display:none;">
      <div class="addrBox__title">Forslag (velg ett)</div>
      <div id="businessList" class="addrBox__list"></div>
    </div>

    <div class="row">
      <div>
        <label>ByggeÃ¥r</label>
        <input id="buildYear" inputmode="numeric" placeholder="Ã…r" />
      </div>
      <div>
        <label>Totalareal (mÂ²)</label>
        <input id="areaM2" inputmode="numeric" placeholder="mÂ²" />
      </div>
    </div>

    <div class="muted" style="margin-top:8px;">
      Fordel totalarealet per bruksomrÃ¥de (basert pÃ¥ valgte virksomheter).
    </div>
    <div id="areaBreakdown"></div>
    <div class="muted" id="areaSumStatus"></div>

    <div class="row">
      <div>
        <label>Antall etg.</label>
        <input id="floors" inputmode="numeric" placeholder="Antall" />
      </div>
      <div></div>
    </div>

    <hr style="margin:16px 0; border:none; border-top:1px solid #eee;">

    <h4>Konstruksjon â€“ Materialer</h4>
    
    <div class="report__infobox" style="margin-bottom:16px;">
      <p>
        Velg materialer per konstruksjonsdel.
      </p>
    </div>

    <!-- Konstruksjonsdeler med Material-valg -->
    <div id="constructionPartsContainer">
      <!-- Rendres dynamisk fra app.js -->
    </div>

    <hr style="margin:16px 0; border:none; border-top:1px solid #eee;">

    <h4>Beskyttelse</h4>
    <div class="report__infobox" style="margin-bottom:16px;">
      <p>
        Registrer beskyttende tiltak.
      </p>
    </div>
    <div id="protectionChips" class="chips"></div>

    <hr style="margin:16px 0; border:none; border-top:1px solid #eee;">

    <div style="display:flex; align-items:center; justify-content:space-between; position:relative;">
      <label style="margin:0;">Bygningsbeskrivelse</label>
      <button class="btn-icon" id="btnHelpDesc" title="Hjelpetekst">?</button>
      <div popover="auto" id="popDesc" class="help-popover">
        <button class="help-popover__close" aria-label="Lukk">Ã—</button>
        <div class="help-popover__content">
          Her fÃ¸res korte kommentarer til den skjematiske fremstilling av bygget i tabellen. For eksempel kan det beskrives litt nÃ¦rmere om; isolasjons materialer, innvendige brannvegger, avstand til nabobygg, eller andre forhold som kan betydning for risikovurderingen av anlegget.
        </div>
      </div>
    </div>
    <textarea id="bDesc"></textarea>

    <div style="display:flex; align-items:center; justify-content:space-between; position:relative;">
      <label style="margin:0;">Sikkerhetsforhold</label>
      <button class="btn-icon" id="btnHelpSafety" title="Hjelpetekst">?</button>
      <div popover="auto" id="popSafety" class="help-popover">
        <button class="help-popover__close" aria-label="Lukk">Ã—</button>
        <div class="help-popover__content">
          Her beskrives kort branntekniske eller andre risikoforhold som for eks.: Utplassering og merking av slukkeutstyr, avfallshÃ¥ndtering, orden i rÃ¸mningsveier, tilstanden til branndÃ¸rer, innbruddsikring osv. Er det lite Ã¥ bemerke og man ikke finner det formÃ¥lstjenlig Ã¥ utstede liste med anbefalinger eller fotorapport kan befaringsrapporten avsluttes her og Ã¸vrige sider slettes.
        </div>
      </div>
    </div>
    <textarea id="bSafety"></textarea>

    <div style="display:flex; align-items:center; justify-content:space-between; position:relative;">
      <label style="margin:0;">Generell vurdering av risiko</label>
      <button class="btn-icon" id="btnHelpRisk" title="Hjelpetekst">?</button>
      <div popover="auto" id="popRisk" class="help-popover">
        <button class="help-popover__close" aria-label="Lukk">Ã—</button>
        <div class="help-popover__content">
          Her beskrives den generelle vurderingen av risikoen, som ikke omfatter bygningsbeskrivelse eller sikkerhetsforhold. Forvaltning, drift og vedlikehold skal kommenteres spesifikt her.
        </div>
      </div>
    </div>
    <textarea id="bRisk"></textarea>

    <div class="btn-row">
      <button class="btn btn--chip" id="btnAddBuilding">+ Nytt bygg</button>
    </div>

    <div class="mobile-actionbar">
      <div class="btn-row">
        <button class="btn btn--secondary" id="btnToFindings">Registrer avvik/anbefaling</button>
      </div>
    </div>
  </section>

  <!-- TRINN 2: AVVIK / ANBEFALING (knyttes til objekt) -->
  <section class="card" id="stepFindings" style="display:none;">
    <h2>Avvik / anbefaling</h2>
    <p class="muted">Legg inn avvik/anbefaling og koble til riktig objekt dersom det finnes flere lokasjoner.</p>

    <div class="row">
      <div>
        <label>Gjelder objekt</label>
        <select id="findingLocation"></select>
      </div>
      <div>
        <label>Type</label>
        <select id="findingType">
          <option value="AVVIK" selected>Avvik</option>
          <option value="ANBEFALING">Anbefaling</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Alvorlighet (kun avvik)</label>
        <select id="findingSeverity">
          <option value="HÃ¸y">HÃ¸y</option>
          <option value="Middels" selected>Middels</option>
          <option value="Lav">Lav</option>
        </select>
      </div>
      <div>
        <label>Frist (kun avvik)</label>
        <input id="findingDue" type="date" />
      </div>
    </div>

    <label>Tittel</label>
    <input id="findingTitle" placeholder="Kort beskrivelse" />

    <label>Beskrivelse</label>
    <textarea id="findingDesc" placeholder="Hva er observert? Hva anbefales?"></textarea>

    <div class="btn-row" style="margin-top: 12px;">
      <button class="btn btn--primary" id="btnAddImageAnnotations">ðŸ“· Legg til bilder</button>
    </div>

    <div id="imageThumbnails"></div>

    <div class="btn-row">
      <button class="btn btn--secondary" id="btnAiSuggest" style="display:none;">ðŸ¤– ForeslÃ¥ tekst fra bilde (AI)</button>
    </div>

    <div id="aiSuggestStatus" style="display:none; margin-top:8px; padding:8px; background:#f0f0f0; border-radius:4px;">
      <div class="muted" id="aiSuggestMessage"></div>
    </div>

    <div class="mobile-actionbar">
      <div class="btn-row">
        <button class="btn btn--primary" id="btnAddFinding">Lagre avvik anbefaling</button>
      </div>
    </div>

    <div id="findingList"></div>

    <hr style="margin:24px 0; border:none; border-top:1px solid #eee;">

    <div class="mobile-actionbar">
      <div class="btn-row">
        <button class="btn btn--tertiary" id="btnBackToLocations">Tilbake: Lokasjoner</button>
      </div>
    </div>
  </section>

  <!-- TRINN 3: RAPPORT -->
  <section class="card" id="stepReport" style="display:none;">
    <div class="report-header">
      <h1>Rapport</h1>
      <div class="report-actions">
        <button class="btn btn--secondary" id="btnExportPDF">ðŸ“„ Ã…pne som PDF</button>
        <button class="btn btn--secondary" id="btnExportEmail">ðŸ“§ Send pÃ¥ e-post</button>
      </div>
    </div>

    <hr style="margin:20px 0; border:none; border-top:1px solid #ddd;">

    <div style="background:#f0f8ff; border-left:4px solid #0DB28A; padding:12px 16px; margin:16px 0; border-radius:4px; font-size:13px; color:#333;">
      <strong>ðŸ’¡ Tips for farge i utskrift:</strong><br>
      NÃ¥r du trykker Â«Ã…pne som PDFÂ» og deretter Â«Skriv utÂ», husk Ã¥:<br>
      âœ“ SlÃ¥ pÃ¥ <strong>Bakgrunnsgrafikk</strong><br>
      âœ“ Velg <strong>Farge</strong> (ikke Svart/hvitt) under Â«Flere innstillingerÂ»
    </div>

    <div id="reportPreview" class="report-preview">
      <!-- Rapporten rendres her av JavaScript -->
    </div>
      <div class="btn-row" style="margin-top:16px;">
        <a class="btn btn--tertiary" href="#top">Til toppen</a>
      </div>
  </section>

</main>

<script src="./imageStore.js"></script>
<script src="./imageAnnotator.js"></script>
<script src="./imageCaptureFlow.js"></script>
<script src="./thumbnailGrid.js"></script>
<script src="./src/config/materials.js"></script>
<script src="./app.js"></script>
</body>
</html>
